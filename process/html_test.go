package process

import (
	"bytes"
	"io/ioutil"
	"net/http"
	"testing"
)

type (
	test struct {
		linkCount  int
		assetCount int
		html       string
	}
)

func buildHtml(head, body string) string {
	return "<html><head>" + head + "</head><body>" + body + "</body></html>"
}
func TestHtml(t *testing.T) {
	tests := []test{
		test{0, 1, buildHtml(`<link href="/css/layout.css"></link>`, ``)},
		test{0, 1, buildHtml(`<script src="/js/min.js"></script>`, ``)},
		test{1, 0, buildHtml(``, `<a href="/">link</a>`)},
		test{0, 1, buildHtml(``, `<img src="/img.jpg"/>`)},
		test{59, 16, `<!doctype html><html data-placeholder-focus="false"> <head>  <!-- Google Analytics Content Experiment code --> <script>function utmx_section(){}function utmx(){}(function(){var k='52054446-2',d=document,l=d.location,c=d.cookie; if(l.search.indexOf('utm_expid='+k)>0)return; function f(n){if(c){var i=c.indexOf(n+'=');if(i>-1){var j=c. indexOf(';',i);return escape(c.substring(i+n.length+1,j<0?c. length:j))}}}var x=f('__utmx'),xx=f('__utmxx'),h=l.hash;d.write( '<sc'+'ript src="'+'http'+(l.protocol=='https:'?'s://ssl': '://www')+'.google-analytics.com/ga_exp.js?'+'utmxkey='+k+ '&utmx='+(x?x:'')+'&utmxx='+(xx?xx:'')+'&utmxtime='+new Date(). valueOf()+(h?'&utmxhash='+escape(h.substr(1)):'')+ '" type="text/javascript" charset="utf-8"><\/sc'+'ript>')})(); </script><script>utmx('url','A/B');</script> <!-- End of Google Analytics Content Experiment code -->  <meta charset="utf-8"> <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">  <title>Simple Cloud Infrastructure for Developers | DigitalOcean</title> <meta name="description" content="Spin up an SSD cloud server, with full root access, in under a minute. Pricing starts at $5/mo for 512MB RAM, 20GB SSD, 1CPU and 1TB transfer."> <meta name="keywords" content="cloud server, cloud hosting, vps, vps server, vps server hosting, vps hosting, virtual server, virtual private server, ubuntu server, centos server, debian server, linux server, fedora server, linux mint server"><meta name="twitter:card" content="Spin up an SSD cloud server, with full root access, in under a minute. Pricing starts at $5/mo for 512MB RAM, 20GB SSD, 1CPU and 1TB transfer."><meta name="twitter:site" content="DigitalOcean"><meta name="twitter:title" content="Simple Cloud Infrastructure for Developers"><meta name="twitter:description" content="Spin up an SSD cloud server, with full root access, in under a minute. Pricing starts at $5/mo for 512MB RAM, 20GB SSD, 1CPU and 1TB transfer."><meta name="og:title" content="Simple Cloud Infrastructure for Developers"><meta name="og:description" content="Spin up an SSD cloud server, with full root access, in under a minute. Pricing starts at $5/mo for 512MB RAM, 20GB SSD, 1CPU and 1TB transfer."><meta name="og:site_name" content="DigitalOcean"><meta property="og:image" content='https://www.digitalocean.com/assets/images/'>  <script src="//d2wy8f7a9ursnm.cloudfront.net/bugsnag-2.min.js" data-apikey="5521483091d79def55edefe4abaec88a"></script> <script type="text/javascript"> Bugsnag.releaseStage = "build"; Bugsnag.notifyReleaseStages = ["build"]; </script>  <link rel="canonical" href="https://www.digitalocean.com" /> <script src="//cdn.optimizely.com/js/701281621.js"></script>   <meta name="viewport" content="width = device-width, initial-scale = 1.0" />  <link href="/assets/css/style-3904426a.css" media="screen" rel="stylesheet" type="text/css" /> <script type="text/javascript" src="//use.typekit.net/njm7orv.js"></script> <script type="text/javascript">try{Typekit.load();}catch(e){}</script> <script type="text/javascript"> if(window.analytics=window.analytics||[],window.analytics.included)window.console&&console.error&&console.error("analytics.js included twice");else{window.analytics.included=!0,window.analytics.methods=["identify","group","track","page","pageview","alias","ready","on","once","off","trackLink","trackForm","trackClick","trackSubmit"],window.analytics.factory=function(a){return function(){var n=Array.prototype.slice.call(arguments);return n.unshift(a),window.analytics.push(n),window.analytics}};for(var i=0;i<window.analytics.methods.length;i++){var key=window.analytics.methods[i];window.analytics[key]=window.analytics.factory(key)}window.analytics.load=function(a){var n=document.createElement("script");n.type="text/javascript",n.async=!0,n.src=("https:"===document.location.protocol?"https://":"http://")+"cdn.segment.com/analytics.js/v1/"+a+"/analytics.min.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(n,t)},window.analytics.SNIPPET_VERSION="2.0.9", window.analytics.load("eodkqsm339")} window.analytics.page();</script> </head> <body class="index signups-full_index announcement"> <!-- Google Tag Manager --><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-KHWBBT"height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-KHWBBT');</script><!-- End Google Tag Manager --> <div class="mobile-nav"> <div class="m-pikabu-sidebar m-pikabu-left"> <nav id="button-nav"> <ul> <li><a href="https://cloud.digitalocean.com/login">Log In</a></li> <li class="button-outline"><a href="https://cloud.digitalocean.com/registrations/new">Sign Up</a></li> </ul> </nav> <a href="#" class="close-panel icon-close"></a> <nav id="mobile"> <ul> <li><a class="" href="/pricing/">Pricing</a></li> <li><a class="" href="/features/">Features</a></li> <li><a class="" href="/community/">Community</a></li> <li><a class="" href="/help/">Help</a></li> </ul> </nav> </div></div> <div class="m-pikabu-container">  <header> <div class="wrapper-full">   <a class="logo" href="">DigitalOcean</a>   <a id="hiring" href="/company/careers/">We're Hiring!</a> <a class="m-pikabu-nav-toggle icon-navicon" data-role="left"> <span></span> </a> <nav id="button-nav"> <ul> <li><a href="https://cloud.digitalocean.com/login">Log In</a></li> <li class="button-outline"><a href="https://cloud.digitalocean.com/registrations/new">Sign Up</a></li> </ul> </nav> <nav> <ul> <li><a class="" href="/pricing/">Pricing</a></li> <li><a class="" href="/features/">Features</a></li> <li><a class="" href="/community/">Community</a></li> <li><a class="" href="/help/">Help</a></li> </ul> </nav> </div></header>  <section class="main"> <!--***ADD LINES BELOW INTO BANNER FOR ICON***image_path: "/assets/images/atlantis-dc.png"image_alt: "FreeBSD on DigitalOcean" --><div id="announcement"> <div class="wrapper-full"> <div class="inner">   <a class="external" href="/company/blog/introducing-our-new-canadian-datacenter-tor1/">Introducing TOR1 - Our New Canadian Datacenter!</a>  </div> </div></div><section class="homepage-header"> <div class="wrapper-full"> <div class="container top-section"> <div class="main-content"> <div class="left"> <h1> <strong>DigitalOcean</strong> <br> Simple Cloud Hosting, <br> Built for Developers. </h1> <h2> Deploy an SSD cloud server <br> in 55 seconds. </h2> <form accept-charset="UTF-8" action="https://cloud.digitalocean.com/registrations" class="form-inline signup" id="new_user" method="post"> <input id="user_signup_form_name" name="user[signup_form_name]" type="hidden" value="Homepage"> <input class="focus" autofocus id="user_email" name="user[email]" placeholder="Email Address" size="30" type="text" value=""> <input id="user_password" name="user[password]" placeholder="Password" size="30" type="password"> <input class="" name="commit" type="submit" value="Create Account"> <div class="clearfix"></div> </form> </div> <div class="right"> <div class="browser"> <div class="crossbar"> <ul class="dots"> <li class="red"></li> <li class="yellow"></li> <li class="green"></li> </ul> </div> <div class="browser-content"></div> </div> </div> </div> </div> <div class="hide-group"> <div class="container"> <div class="wrap-content" id="pricing"> <h3 class="hasSub">Straightforward Pricing</h3> <p class="sub-header">Pay only for resources you actually use, by the hour. No setup fee, no minimum spend.</p> <ul class="pricing-chart"> <li> <div class="pricing-top"> <span class="dollar">5<span class="perMonth">/mo</span></span> <span class="perHour">$0.007/hour</span> </div> <div class="plan-details"> <span class="size-cpu">512MB / <span style="color: #777;">1 cpu</span></span> <span class="size-disk">20GB <span style="color: #777;">SSD Disk</span></span> <span class="size-transfer">1TB <span style="color: #777;">Transfer</span></span> </div> </li> <li> <div class="pricing-top preferred-top"> <span class="dollar">10<span class="perMonth">/mo</span></span> <span class="perHour">$0.015/hour</span> </div> <span class="preferred">MOST POPULAR PLAN</span> <div class="plan-details"> <span class="size-cpu">1GB / <span style="color: #777;">1 cpu</span></span> <span class="size-disk">30GB <span style="color: #777;">SSD Disk</span></span> <span class="size-transfer">2TB <span style="color: #777;">Transfer</span></span> </div> </li> <li> <div class="pricing-top"> <span class="dollar">20<span class="perMonth">/mo</span></span> <span class="perHour">$0.03/hour</span> </div> <div class="plan-details"> <span class="size-cpu">2GB / <span style="color: #777;">2 cpu</span></span> <span class="size-disk">40GB <span style="color: #777;">SSD Disk</span></span> <span class="size-transfer">3TB <span style="color: #777;">Transfer</span></span> </div> </li> <li> <div class="pricing-top"> <span class="dollar">40<span class="perMonth">/mo</span></span> <span class="perHour">$0.06/hour</span> </div> <div class="plan-details"> <span class="size-cpu">4GB / <span style="color: #777;">2 cpu</span></span> <span class="size-disk">60GB <span style="color: #777;">SSD Disk</span></span> <span class="size-transfer">4TB <span style="color: #777;">Transfer</span></span> </div> </li> <li> <div class="pricing-top"> <span class="dollar">80<span class="perMonth">/mo</span></span> <span class="perHour">$0.119/hour</span> </div> <div class="plan-details"> <span class="size-cpu">8GB / <span style="color: #777;">4 cpu</span></span> <span class="size-disk">80GB <span style="color: #777;">SSD Disk</span></span> <span class="size-transfer">5TB <span style="color: #777;">Transfer</span></span> </div> </li> </ul> <a href="https://cloud.digitalocean.com/registrations/new" class="Button--blue">Get Started</a> </div> </div> <div class="container"> <div class="wrap-content" id="dev-love"> <h3>Over <span class="semibold">550,000 developers</span> have deployed to our cloud.</h3> <ul class="testimonials-list"> <li> <span class="headshot"> <img src="/assets/images/john_resig-d2a6de9f.jpg"> </span> <p>“The speed and simplicity of deploying my projects to DigitalOcean has greatly increased my productivity.”</p> <div class="dev-details"> <h4> John Resig <span>Creator of jQuery</span> </h4> </div> </li> <li> <span class="headshot"> <img src="assets/images/xavier_noria-f45931ec.jpg"> </span> <p>“Migrated the Rails API and my humbled homepage to your hosting, fantastic user experience well done guys.”</p> <div class="dev-details"> <h4> Xavier Noria <span>Rails Core Team Member</span> </h4> </div> </li> <li> <span class="headshot"> <img src="/assets/images/salvatore_sanfilippo-84e0aa94.jpg"> </span> <p>“Guess what...you provide service for 1/4 of the cost, and you win DigitalOcean.”</p> <div class="dev-details"> <h4> Salvatore Sanfilippo <span>Creator of Redis</span> </h4> </div> </li> <li> <span class="headshot"> <img src="/assets/images/ryan_bates-b028c962.jpg"> </span> <p>“DigitalOcean is offering an amazing service at a great price.”</p> <div class="dev-details"> <h4> Ryan Bates <span>Creator of RailsCasts</span> </h4> </div> </li> </ul> </div> </div> <div class="container"> <div class="wrap-content" id="success-stories"> <h3>Read our customer success stories</h3> <ul class="brand-logos"> <li> <a href="customers/taskrabbit"> <img src="/assets/images/customersuccess/taskrabbit-f952fc3f.png"> </a> </li> <li> <a href="customers/jquery-foundation"> <img src="/assets/images/customersuccess/jquery-c39664cf.png"> </a> </li> <li> <a href="customers/compose"> <img src="/assets/images/customersuccess/compose-65ff01e0.png"> </a> </li> <li> <a href="customers/influxdb"> <img src="/assets/images/customersuccess/influx-db-f05a1f73.png"> </a> </li> <li> <a href="customers/pertino"> <img src="/assets/images/customersuccess/pertino-9d696fca.png"> </a> </li> </ul> </div> </div> <div class="container"> <div class="wrap-content" id="bottom-signup"> <h3>Deploy an SSD cloud server in 55 seconds.</h3> <form accept-charset="UTF-8" action="https://cloud.digitalocean.com/registrations" class="form-inline signup" id="new_user" method="post"> <input id="user_signup_form_name" name="user[signup_form_name]" type="hidden" value="Homepage"> <input id="user_email" name="user[email]" placeholder="Email Address" size="30" type="text" value=""> <input id="user_password" name="user[password]" placeholder="Password" size="30" type="password"> <input class="" name="commit" type="submit" value="Create Account"> <div class="clearfix"></div> </form> </div> </div> </div> </div></section> </section>  <footer> <div class="wrapper-full"> <div id="column-main" class="footer-column"> <a class="cloud-icon" href="/">DigitalOcean</a> <div id="copyright"> Copyright &copy; 2015<br> DigitalOcean &trade; Inc. </div> <a id="made-in-ny" href="http://nytm.org/made-in-nyc/">Proudly Made in NY</a> <div id="privacy"> <a href="/legal/terms/">Terms, Privacy & Copyright</a> <a href="/security/">Security</a> </div> <a id="hiring" href="/company/careers/">We're Hiring!</a> </div> <div id="column-product" class="footer-column"> <h3>Product</h3> <ul> <li><a href="/pricing/">Pricing</a></li> <li><a href="/features/">Features</a></li> <li><a href="/customers/">Customers</a></li> <li><a href="/features/one-click-apps/">One-Click Apps</a></li> <li><a href="https://developers.digitalocean.com/documentation/v2/">API</a></li> </ul> </div> <div id="column-company" class="footer-column"> <h3>Company</h3> <ul> <li><a href="/company/about/">About Us</a></li> <li><a href="/company/blog/">Blog</a></li> <li><a href="/company/careers/">Careers</a></li> <li><a href="/company/press/">Press</a></li> <li><a class="external" href="http://www.meetup.com/DigitalOcean_Community">Events</a></li> <li><a href="/company/logos-and-badges/">Logos & Badges</a></li> <li><a href="/company/contact/">Contact</a></li> </ul> </div> <div id="column-help" class="footer-column"> <h3>Help</h3> <ul> <li><a href="/help/getting-started/">Getting Started</a></li> <li><a class="external" href="https://digitalocean.uservoice.com">Feedback</a></li> <li><a href="/referral-program/">Referral Program</a></li> <li><a class="external" href="https://status.digitalocean.com/">Network Status</a></li> <li><a href="/help/">FAQ</a></li> </ul> </div> <div id="column-community" class="footer-column"> <h3>Community</h3> <ul> <li><a href="/community/">Dashboard</a></li> <li><a href="/community/articles">Tutorials</a></li> <li><a href="/community/questions">Questions</a></li> <li><a href="/community/projects">Projects</a></li> <li><a href="/community/articles/digitalocean-community-article-suggestions-and-ideas">Tutorial Suggestions</a></li> <li><a href="/community/get-paid-to-write">Get Paid to Write</a></li> </ul> </div> <div id="column-connect" class="footer-column"> <h3>Connect</h3> <ul> <li class="blog"><a href="/company/blog/">Blog</a></li> <li class="twitter"><a class="external" href="https://twitter.com/digitalocean">Twitter</a></li> <li class="facebook"><a class="external" href="https://www.facebook.com/DigitalOceanCloudHosting">Facebook</a></li> <li class="linkedin"><a class="external" href="http://www.linkedin.com/company/digitalocean">LinkedIn</a></li> <li class="github"><a class="external" href="https://github.com/digitalocean">GitHub</a></li> <li class="google"><a target="_blank" href="https://plus.google.com/+Digitalocean/posts">Google+</a></li> <li class="instagram"><a class="external" href="http://instagram.com/thedigitalocean">Instagram</a></li> <li class="meetup"><a class="external" href="http://www.meetup.com/DigitalOcean_Community/">Meetup</a></li> <li class="youtube"><a class="external" href="https://www.youtube.com/user/DigitalOceanVideos">Youtube</a></li> </ul> </div> <div id="droplet-count"> <span class="count"></span> Droplets Launched </div> </div></footer>  </div> <script src="/assets/js/vendor.bundle-37da1cb4.js" type="text/javascript"></script><script src="/assets/js/application.bundle-119b1764.js" type="text/javascript"></script>  <script type="text/javascript"> $(document).ready(function () { var matches = window.location.search.match(/refcode=(\w+)/); if (matches) { var refcode = matches[1]; $.ajax({ type: "GET", url: referralRegistrationUrl(refcode, 'build'), crossDomain: true, xhrFields: { withCredentials: true } }).fail(function(xhr, textStatus, err) { var errorText = 'xhrSstatus => ' + xhr.status + ', text => "' + xhr.statusText + '", ' + 'errText => "' + textStatus + '", jsErr => ' + err.toString() + '"'; window.Bugsnag && window.Bugsnag.notify("AjaxError", "Setting referral code failed: " + errorText); }); } });</script> </body></html>`},
	}
	for _, test := range tests {
		page := &Page{
			Res: &http.Response{
				Body: ioutil.NopCloser(bytes.NewReader([]byte(test.html))),
			},
		}
		next, err := ParseHTML(page)
		if err != nil {
			t.Log("failed to parse html", err, test.html)
			t.Fail()
			continue
		}
		result, err := CompileNodeInfo(next)
		if err != nil {
			t.Log("failed to walk nodes", err, test.html)
			t.Fail()
		}
		page = result.(*Page)
		if test.linkCount != len(page.Links) {
			t.Log("wrong number of links were found", len(page.Links), page.Links, test.html)
			t.Fail()
		}
		if test.assetCount != len(page.Assets) {
			t.Log("wrong number of assets were found", len(page.Assets), page.Assets, test.html)
			t.Fail()
		}
	}
}
